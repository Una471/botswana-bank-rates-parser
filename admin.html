<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard ‚Äî BW Bank Rates</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }

        .header {
            background: linear-gradient(135deg, #0C2340 0%, #1a3a5c 100%);
            color: white; padding: 22px 30px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
        }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5em; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .nav-btn {
            padding: 8px 20px; background: rgba(255,255,255,0.12); border: 1.5px solid rgba(255,255,255,0.3);
            color: white; border-radius: 20px; cursor: pointer; font-size: 0.88em; text-decoration: none;
            display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.22); }
        .nav-btn.gold { background: #C9A84C; border-color: #C9A84C; color: #0C2340; font-weight: 700; }

        .container { max-width: 1400px; margin: 32px auto; padding: 0 24px; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 24px 28px; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border-left: 4px solid #C9A84C; }
        .stat-card h3 { color: #888; font-size: 0.78em; text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 8px; }
        .stat-card .number { font-size: 2.2em; font-weight: 800; color: #0C2340; }
        .stat-card .sub { font-size: 0.78em; color: #aaa; margin-top: 4px; }

        /* Upload */
        .upload-section { background: white; border-radius: 16px; padding: 36px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-bottom: 28px; }
        .upload-section h2 { margin-bottom: 20px; font-size: 1.15em; color: #0C2340; }
        .upload-zone {
            border: 2.5px dashed #C9A84C; border-radius: 14px; padding: 52px;
            text-align: center; transition: all 0.3s; cursor: pointer;
        }
        .upload-zone:hover, .upload-zone.dragover { background: rgba(201,168,76,0.06); border-color: #a07c28; }
        .upload-icon { font-size: 3.5em; color: #C9A84C; margin-bottom: 14px; }
        .upload-text { font-size: 1.1em; font-weight: 600; color: #333; margin-bottom: 6px; }
        .upload-subtext { color: #999; font-size: 0.875em; }
        #fileInput { display: none; }
        .progress-bar { width: 100%; height: 24px; background: #f0f0f0; border-radius: 12px; overflow: hidden; margin-top: 20px; display: none; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #0C2340, #C9A84C); width: 0%; transition: width 0.4s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.82em; }

        /* Preview */
        .preview-section { background: white; border-radius: 16px; padding: 36px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-bottom: 28px; display: none; }
        .preview-section.show { display: block; }
        .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .preview-header h2 { font-size: 1.15em; color: #0C2340; }
        .action-buttons { display: flex; gap: 10px; }
        .btn { padding: 10px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.88em; transition: all 0.2s; }
        .btn-approve { background: #059669; color: white; }
        .btn-approve:hover { background: #047857; }
        .btn-reject { background: #DC2626; color: white; }
        .btn-reject:hover { background: #B91C1C; }
        .btn-edit { background: #F59E0B; color: #1A2535; }
        .btn-edit:hover { background: #D97706; }

        .bank-name-highlight {
            background: linear-gradient(135deg, #0C2340, #1a3a5c);
            color: white; padding: 18px 24px; border-radius: 12px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .bank-name-highlight h3 { font-size: 1.4em; }
        .bank-name-highlight p { opacity: 0.6; font-size: 0.85em; margin-top: 3px; }
        .bank-name-highlight .plr-display { text-align: right; }
        .bank-name-highlight .plr-value { font-size: 1.8em; font-weight: 800; color: #C9A84C; }
        .bank-name-highlight .plr-label { font-size: 0.72em; opacity: 0.6; letter-spacing: 0.06em; text-transform: uppercase; }

        /* Section dividers in preview table */
        .section-row td {
            background: #0C2340; color: white; font-size: 0.72em; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.1em; padding: 8px 15px;
        }

        .preview-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .preview-table th, .preview-table td { padding: 11px 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .preview-table th { background: #f8f9fa; font-weight: 600; color: #444; font-size: 0.875em; width: 40%; }
        .preview-table td { color: #555; font-size: 0.875em; }
        .preview-table tr:hover td, .preview-table tr:hover th { background: #f8f9fa; }
        .field-empty { color: #DC2626; font-style: italic; font-size: 0.85em; }
        .field-filled { color: #059669; font-weight: 600; }
        .field-edit input { width: 100%; padding: 7px 10px; border: 1.5px solid #C9A84C; border-radius: 6px; font-size: 0.875em; font-family: inherit; }

        /* Extraction quality bar */
        .quality-bar { background: #f0f0f0; border-radius: 8px; height: 8px; margin: 12px 0; }
        .quality-fill { height: 100%; border-radius: 8px; background: linear-gradient(90deg, #059669, #34D399); transition: width 0.5s; }
        .quality-label { font-size: 0.8em; color: #666; margin-bottom: 4px; }

        /* Field Guide */
        .field-guide { background: #EFF6FF; border: 1px solid #BFDBFE; border-radius: 14px; padding: 28px; margin-bottom: 28px; }
        .field-guide h3 { color: #1E40AF; font-size: 1em; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .field-columns { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .field-col h4 { font-size: 0.78em; font-weight: 700; color: #2563EB; text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #BFDBFE; }
        .field-col .field-item { font-size: 0.8em; padding: 4px 0; color: #374151; display: flex; justify-content: space-between; }
        .field-type { color: #6B7280; font-style: italic; }

        /* Recent uploads */
        .recent-uploads { background: white; border-radius: 16px; padding: 36px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        .recent-uploads h2 { margin-bottom: 20px; font-size: 1.15em; color: #0C2340; }
        .uploads-table { width: 100%; border-collapse: collapse; }
        .uploads-table th, .uploads-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #f0f0f0; font-size: 0.875em; }
        .uploads-table th { background: #f8f9fa; font-weight: 700; font-size: 0.78em; color: #555; text-transform: uppercase; letter-spacing: 0.06em; }
        .status-badge { padding: 3px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        .status-success { background: #ECFDF5; color: #059669; }
        .status-error { background: #FEF2F2; color: #DC2626; }

        .notification { position: fixed; top: 20px; right: 20px; padding: 18px 24px; background: white; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.15); display: none; z-index: 1000; max-width: 380px; border-left: 4px solid #059669; }
        .notification.show { display: block; animation: slideIn 0.3s; }
        .notification.error { border-left-color: #DC2626; }
        .notification.info { border-left-color: #2563EB; }
        @keyframes slideIn { from { transform: translateX(420px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .download-btn {
            background: #0C2340;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875em;
            margin-top: 20px;
        }
        .download-btn:hover {
            background: #1a3a5c;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-content">
        <h1><i class="fas fa-shield-alt"></i> Admin Dashboard ‚Äî BW Bank Rates</h1>
        <div class="header-actions">
            <a href="index.html" class="nav-btn"><i class="fas fa-home"></i> Public Site</a>
            <a href="savings.html" class="nav-btn"><i class="fas fa-piggy-bank"></i> Savings</a>
            <a href="fixed-deposits.html" class="nav-btn"><i class="fas fa-lock"></i> Fixed Deposits</a>
            <a href="loans.html" class="nav-btn"><i class="fas fa-hand-holding-usd"></i> Loans</a>
        </div>
    </div>
</div>

<div class="container">

    <!-- Stats -->
    <div class="dashboard-grid">
        <div class="stat-card">
            <h3>Uploads This Session</h3>
            <div class="number" id="totalUploads">0</div>
        </div>
        <div class="stat-card">
            <h3>Fields Per Record</h3>
            <div class="number">44</div>
            <div class="sub">Including all rates + metadata</div>
        </div>
        <div class="stat-card">
            <h3>PDF Parser Status</h3>
            <div class="number" id="parserStatus">Active</div>
            <div class="sub">Gemini Vision API</div>
        </div>
        <div class="stat-card">
            <h3>Last Upload</h3>
            <div class="number" id="lastUpload" style="font-size:1.2em">‚Äî</div>
        </div>
    </div>

    <!-- Field Guide -->
    <div class="field-guide">
        <h3><i class="fas fa-list-check"></i> Fields Being Extracted (44 total)</h3>
        <div class="field-columns">
            <div class="field-col">
                <h4>Metadata</h4>
                <div class="field-item">Bank Name</div>
                <div class="field-item">Data Month</div>
                <div class="field-item">Report Period</div>
                <div class="field-item">MoPR</div>
                <div class="field-item">Prime Lending Rate</div>
                <div class="field-item">Contact Phone</div>
                <div class="field-item">Website</div>
            </div>
            <div class="field-col">
                <h4>Savings / Deposit</h4>
                <div class="field-item">Current Account Min/Max</div>
                <div class="field-item">Call Account Min/Max (Nom/Eff)</div>
                <div class="field-item">Savings Min/Max (Nom/Eff)</div>
                <div class="field-item">Ordinary Savings Min/Max</div>
                <div class="field-item">SAYE Min/Max (Nom/Eff)</div>
            </div>
            <div class="field-col">
                <h4>Fixed Deposits</h4>
                <div class="field-item">91 Day (Nom/Eff Min/Max)</div>
                <div class="field-item">3 Month (Nom/Eff Min/Max)</div>
                <div class="field-item">6 Month (Nom/Eff Min/Max)</div>
                <div class="field-item">12 Month (Nom/Eff Min/Max)</div>
                <div class="field-item">24 Month (Nom/Eff Min/Max)</div>
                <div class="field-item">Over 24M (Nom/Eff Min/Max)</div>
                <div class="field-item">FD Minimum Balance</div>
            </div>
            <div class="field-col">
                <h4>Lending Rates</h4>
                <div class="field-item">Mortgage Min/Max</div>
                <div class="field-item">Overdraft Min/Max</div>
                <div class="field-item">Credit Card Min/Max</div>
                <div class="field-item">Car Loan Min/Max</div>
                <div class="field-item">Lease Loan Min/Max</div>
                <div class="field-item">Personal Loan Min/Max</div>
                <div class="field-item">Other LT Min/Max</div>
            </div>
        </div>
    </div>

    <!-- PDF Upload -->
    <div class="upload-section">
        <h2><i class="fas fa-file-pdf" style="color:#DC2626"></i> Upload Bank Rate PDF</h2>
        <div class="upload-zone" id="uploadZone">
            <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
            <div class="upload-text">Drop file here or click to browse</div>
            <div class="upload-subtext">
                Supported: <strong>PDF, JPG, PNG</strong> (max 10MB) ¬∑ AI reads it visually
            </div>
            <div style="margin-top:10px;font-size:0.78em;color:#C9A84C">
                üí° Tip: Name files with bank name e.g. "ABSA_March2026.pdf"
            </div>
            <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill">0%</div>
        </div>
    </div>

    <!-- Extracted Data Preview -->
    <div class="preview-section" id="previewSection">
        <div class="preview-header">
            <h2><i class="fas fa-clipboard-check"></i> Extracted Data ‚Äî Review</h2>
            <div class="action-buttons">
                <button class="btn btn-edit" id="editBtn" onclick="enableEdit()"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn btn-reject" onclick="rejectData()"><i class="fas fa-times"></i> Reject</button>
                <button class="btn btn-approve" onclick="downloadData()"><i class="fas fa-download"></i> Download JSON</button>
            </div>
        </div>

        <div class="bank-name-highlight" id="bankNameDisplay">
            <div>
                <h3 id="extractedBankName">‚Äî</h3>
                <p id="extractedPeriod">‚Äî</p>
            </div>
            <div class="plr-display">
                <div class="plr-value" id="plrDisplay">‚Äî</div>
                <div class="plr-label">Prime Lending Rate</div>
            </div>
        </div>

        <div class="quality-label" id="qualityLabel">Extraction quality: ‚Äî</div>
        <div class="quality-bar"><div class="quality-fill" id="qualityFill" style="width:0%"></div></div>

        <table class="preview-table" id="previewTable">
            <thead><tr><th>Field</th><th>Extracted Value</th><th>Status</th></tr></thead>
            <tbody id="previewTableBody"></tbody>
        </table>

        <div style="text-align: right; margin-top: 20px;">
            <a href="#" id="downloadLink" class="download-btn" style="display: none;" download="bank_rates.json">
                <i class="fas fa-download"></i> Download JSON File
            </a>
        </div>
    </div>

    <!-- Recent Uploads -->
    <div class="recent-uploads">
        <h2><i class="fas fa-history"></i> Upload History (This Session)</h2>
        <table class="uploads-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Filename</th>
                    <th>Bank Detected</th>
                    <th>Status</th>
                    <th>Fields Extracted</th>
                </tr>
            </thead>
            <tbody id="uploadsTable">
                <tr><td colspan="5" style="text-align:center;color:#999;padding:24px">No uploads yet this session</td></tr>
            </tbody>
        </table>
    </div>

</div>

<div class="notification" id="notification">
    <div id="notificationMessage"></div>
</div>

<script>
// ============================================================
//  CONFIG
// ============================================================
const CONFIG = {
    PDF_PARSER_ENDPOINT: 'https://rates-parser.vercel.app/api/parse-pdf'
};

let uploadHistory = [];
let currentExtractedData = null;
let currentFilename = null;

// ============================================================
//  FIELD DEFINITIONS
// ============================================================
const FIELD_SECTIONS = [
    {
        label: 'üîñ Identification',
        fields: ['Bank Name', 'Data Month', 'Report Period', 'MoPR', 'Prime Lending Rate', 'Contact Phone', 'Website']
    },
    {
        label: 'üí∞ Savings & Deposit Rates',
        fields: [
            'Current Account Min', 'Current Account Max',
            'Call Account Min', 'Call Account Max', 'Call Account Effective Min', 'Call Account Effective Max',
            'Savings Min', 'Savings Max', 'Savings Effective Min', 'Savings Effective Max',
            'Ordinary Savings Min', 'Ordinary Savings Max',
            'SAYE Min', 'SAYE Max', 'SAYE Effective Min', 'SAYE Effective Max',
        ]
    },
    {
        label: 'üîí Fixed Deposit Rates',
        fields: [
            'FD 91D Nominal Min', 'FD 91D Nominal Max', 'FD 91D Effective Min', 'FD 91D Effective Max',
            'FD 3M Nominal Min', 'FD 3M Nominal Max', 'FD 3M Effective Min', 'FD 3M Effective Max',
            'FD 6M Nominal Min', 'FD 6M Nominal Max', 'FD 6M Effective Min', 'FD 6M Effective Max',
            'FD 12M Nominal Min', 'FD 12M Nominal Max', 'FD 12M Effective Min', 'FD 12M Effective Max',
            'FD 24M Nominal Min', 'FD 24M Nominal Max', 'FD 24M Effective Min', 'FD 24M Effective Max',
            'FD Over24M Nominal Min', 'FD Over24M Nominal Max', 'FD Over24M Effective Min', 'FD Over24M Effective Max',
            'FD Minimum Balance',
        ]
    },
    {
        label: 'üè¶ Lending Rates',
        fields: [
            'Mortgage Rate Min', 'Mortgage Rate Max',
            'Overdraft Min', 'Overdraft Max',
            'Credit Card Rate Min', 'Credit Card Rate Max',
            'Car Loan Min', 'Car Loan Max',
            'Lease Loan Min', 'Lease Loan Max',
            'Personal Loan Min', 'Personal Loan Max',
            'Other LT Min', 'Other LT Max',
        ]
    }
];

// ============================================================
//  UPLOAD ZONE
// ============================================================
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');

uploadZone.addEventListener('click', () => fileInput.click());
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => {
    e.preventDefault(); uploadZone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) handleFileUpload(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => {
    if (e.target.files.length > 0) handleFileUpload(e.target.files[0]);
});

async function handleFileUpload(file) {
    const validExts = ['.pdf', '.jpg', '.jpeg', '.png'];
    const ext = '.' + file.name.split('.').pop().toLowerCase();
    if (!validExts.includes(ext)) { showNotification('Please upload a PDF, JPG, or PNG file', 'error'); return; }
    if (file.size > 10 * 1024 * 1024) { showNotification('File too large (max 10MB)', 'error'); return; }

    currentFilename = file.name;
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    progressBar.style.display = 'block';
    progressFill.style.width = '20%';
    progressFill.textContent = '20% ‚Äî Reading file...';

    const mimeType = ext === '.pdf' ? 'application/pdf' : ext === '.png' ? 'image/png' : 'image/jpeg';

    const reader = new FileReader();
    reader.onload = async e => {
        const base64 = e.target.result.split(',')[1];
        try {
            progressFill.style.width = '55%';
            progressFill.textContent = '55% ‚Äî AI reading document...';

            const response = await fetch(CONFIG.PDF_PARSER_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file.name, content: base64, mimeType })
            });

            const result = await response.json();
            progressFill.style.width = '100%';
            progressFill.textContent = '100%';

            if (response.ok && result.success) {
                currentExtractedData = result.data;
                showPreview(result.data);
                showNotification('‚úÖ ' + result.message, 'success');
                addToUploadHistory(file.name, result.data['Bank Name'], 'success', result.data);
                document.getElementById('lastUpload').textContent = new Date().toLocaleTimeString();
            } else {
                throw new Error(result.error || result.details || 'Upload failed');
            }
        } catch (error) {
            showNotification('‚ùå ' + error.message, 'error');
            addToUploadHistory(file.name, 'Unknown', 'error', null);
        } finally {
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }, 2500);
        }
    };
    reader.readAsDataURL(file);
}

// ============================================================
//  PREVIEW
// ============================================================
function showPreview(data) {
    const tbody = document.getElementById('previewTableBody');
    document.getElementById('extractedBankName').textContent = data['Bank Name'] || 'Unknown Bank';
    document.getElementById('extractedPeriod').textContent = data['Data Month'] || data['Report Period'] || 'Period not detected';
    document.getElementById('plrDisplay').textContent = data['Prime Lending Rate'] ? data['Prime Lending Rate'] + '%' : '‚Äî';
    document.getElementById('editBtn').textContent = '‚úèÔ∏è Edit';
    document.getElementById('editBtn').onclick = enableEdit;

    let html = '';
    let filledCount = 0;
    let totalCount = 0;

    FIELD_SECTIONS.forEach(section => {
        html += `<tr class="section-row"><td colspan="3">${section.label}</td></tr>`;
        section.fields.forEach(field => {
            const value = data[field];
            const isEmpty = value === null || value === undefined || value === '';
            if (!isEmpty) filledCount++;
            totalCount++;
            html += `<tr>
                <th>${field}</th>
                <td data-field="${field}">${isEmpty ? '<span class="field-empty">Not extracted</span>' : `<span class="field-filled">${value}</span>`}</td>
                <td>${isEmpty ? '<i class="fas fa-times-circle" style="color:#DC2626"></i>' : '<i class="fas fa-check-circle" style="color:#059669"></i>'}</td>
            </tr>`;
        });
    });

    tbody.innerHTML = html;
    
    const pct = Math.round((filledCount / totalCount) * 100);
    document.getElementById('qualityLabel').textContent = `Extraction quality: ${filledCount}/${totalCount} fields extracted (${pct}%)`;
    document.getElementById('qualityFill').style.width = pct + '%';
    
    document.getElementById('previewSection').classList.add('show');
    document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function enableEdit() {
    const rows = document.querySelectorAll('#previewTableBody tr:not(.section-row)');
    rows.forEach(row => {
        const td = row.querySelector('td[data-field]');
        if (!td) return;
        const field = td.dataset.field;
        const currentValue = currentExtractedData[field] ?? '';
        td.innerHTML = `<input type="text" 
            value="${currentValue}" 
            data-field="${field}" 
            placeholder="Enter value"
            class="field-edit">`;
    });
    document.getElementById('editBtn').textContent = 'üíæ Save Edits';
    document.getElementById('editBtn').onclick = saveEdits;
}

function saveEdits() {
    document.querySelectorAll('input[data-field]').forEach(input => {
        const field = input.dataset.field;
        let value = input.value.trim();
        if (value === '') { 
            currentExtractedData[field] = null; 
        } else {
            // Try to convert to number if it looks like a number
            const num = parseFloat(value);
            currentExtractedData[field] = isNaN(num) ? value : num;
        }
    });
    showPreview(currentExtractedData);
    showNotification('‚úÖ Edits saved!', 'info');
}

function rejectData() {
    if (confirm('Reject this data?')) {
        document.getElementById('previewSection').classList.remove('show');
        currentExtractedData = null;
        showNotification('Data rejected.', 'error');
    }
}

function downloadData() {
    if (!currentExtractedData) {
        showNotification('No data to download', 'error');
        return;
    }

    const dataStr = JSON.stringify(currentExtractedData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const downloadLink = document.getElementById('downloadLink');
    downloadLink.href = url;
    downloadLink.download = `${currentExtractedData['Bank Name'] || 'bank'}_rates.json`;
    downloadLink.style.display = 'inline-flex';
    downloadLink.click();
    
    setTimeout(() => {
        URL.revokeObjectURL(url);
        downloadLink.style.display = 'none';
    }, 100);
    
    showNotification('‚úÖ JSON file downloaded', 'success');
}

// ============================================================
//  UPLOAD HISTORY
// ============================================================
function addToUploadHistory(filename, bankName, status, data) {
    const filled = data ? Object.values(data).filter(v => v !== null && v !== undefined && v !== '').length : 0;
    uploadHistory.unshift({ date: new Date().toLocaleTimeString(), filename, bankName: bankName||'Unknown', status, filled });
    renderUploadHistory();
    document.getElementById('totalUploads').textContent = uploadHistory.length;
}

function renderUploadHistory() {
    const tbody = document.getElementById('uploadsTable');
    if (uploadHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;padding:24px">No uploads yet</td></tr>';
        return;
    }
    tbody.innerHTML = uploadHistory.slice(0, 10).map(u => `<tr>
        <td>${u.date}</td>
        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${u.filename}</td>
        <td><strong>${u.bankName}</strong></td>
        <td><span class="status-badge ${u.status === 'success' ? 'status-success' : 'status-error'}">${u.status}</span></td>
        <td>${u.filled} / 44 fields</td>
    </tr>`).join('');
}

// ============================================================
//  NOTIFICATION
// ============================================================
function showNotification(message, type = 'success') {
    const el = document.getElementById('notification');
    document.getElementById('notificationMessage').innerHTML = message;
    el.className = `notification ${type} show`;
    setTimeout(() => el.classList.remove('show'), 5000);
}

// ============================================================
//  TEST CONNECTION
// ============================================================
async function testParserConnection() {
    try {
        const response = await fetch(CONFIG.PDF_PARSER_ENDPOINT, {
            method: 'OPTIONS'
        });
        if (response.ok) {
            document.getElementById('parserStatus').innerHTML = '‚úÖ Connected';
        }
    } catch (error) {
        document.getElementById('parserStatus').innerHTML = '‚ö†Ô∏è Check connection';
    }
}

// Initialize
testParserConnection();
</script>
</body>
</html>
