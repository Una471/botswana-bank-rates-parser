<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bank Rates Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2em;
        }

        .logout-btn {
            padding: 10px 25px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }

        .upload-section h2 {
            margin-bottom: 20px;
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-zone:hover {
            background: rgba(102, 126, 234, 0.05);
            border-color: #764ba2;
        }

        .upload-zone.dragover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #999;
        }

        #fileInput {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* EXTRACTED DATA PREVIEW TABLE */
        .preview-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 40px;
            display: none;
        }

        .preview-section.show {
            display: block;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .preview-header h2 {
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-approve {
            background: #28a745;
            color: white;
        }

        .btn-approve:hover {
            background: #218838;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
        }

        .btn-reject:hover {
            background: #c82333;
        }

        .btn-edit {
            background: #ffc107;
            color: #333;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .preview-table th,
        .preview-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            width: 35%;
        }

        .preview-table td {
            color: #666;
        }

        .preview-table tr:hover {
            background: #f8f9fa;
        }

        .field-empty {
            color: #dc3545;
            font-style: italic;
        }

        .field-filled {
            color: #28a745;
            font-weight: 600;
        }

        .bank-name-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .bank-name-highlight h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .bank-name-highlight p {
            opacity: 0.9;
        }

        /* Recent uploads table */
        .recent-uploads {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .recent-uploads h2 {
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            max-width: 400px;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .edit-mode td input {
            width: 100%;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1><i class="fas fa-shield-alt"></i> Admin Dashboard</h1>
            <button class="logout-btn" onclick="window.location.href='index.html'">
                <i class="fas fa-home"></i> View Public Site
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Stats -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3>Total Banks</h3>
                <div class="number" id="totalBanks">0</div>
            </div>
            <div class="stat-card">
                <h3>Last Upload</h3>
                <div class="number" id="lastUpload" style="font-size: 1.2em;">Never</div>
            </div>
            <div class="stat-card">
                <h3>Total Uploads</h3>
                <div class="number" id="totalUploads">0</div>
            </div>
        </div>

        <!-- PDF Upload Section -->
        <div class="upload-section">
            <h2><i class="fas fa-file-pdf"></i> Upload Bank Rate PDF</h2>
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">Drop PDF file here or click to browse</div>
                <div class="upload-subtext">Supported: PDF (Max 10MB) | AI-powered extraction</div>
                <input type="file" id="fileInput" accept=".pdf">
            </div>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <!-- EXTRACTED DATA PREVIEW -->
        <div class="preview-section" id="previewSection">
            <div class="preview-header">
                <h2><i class="fas fa-clipboard-check"></i> Extracted Data Preview</h2>
                <div class="action-buttons">
                    <button class="btn btn-edit" onclick="enableEdit()">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-reject" onclick="rejectData()">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    <button class="btn btn-approve" onclick="approveData()">
                        <i class="fas fa-check"></i> Approve & Save
                    </button>
                </div>
            </div>

            <div class="bank-name-highlight" id="bankNameDisplay">
                <h3 id="extractedBankName">-</h3>
                <p id="extractedPeriod">-</p>
            </div>

            <table class="preview-table" id="previewTable">
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Extracted Value</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="previewTableBody">
                    <!-- Will be populated dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Recent Uploads -->
        <div class="recent-uploads">
            <h2><i class="fas fa-history"></i> Recent Uploads</h2>
            <table>
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Filename</th>
                        <th>Bank Detected</th>
                        <th>Status</th>
                        <th>Fields Extracted</th>
                    </tr>
                </thead>
                <tbody id="uploadsTable">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #999;">No uploads yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div id="notificationMessage"></div>
    </div>

    <script>
        const CONFIG = {
            AIRTABLE_API_KEY: 'patBhLP5wtc8YTY0A.30baf2ceb238a472b12ac9b5db2d366ad0f68a1f6c9363ec15ad96357339053a',
            AIRTABLE_BASE_ID: 'appHKaTJz3Bx550eb',
            AIRTABLE_TABLE_NAME: 'Bank Interest Rates',
            PDF_PARSER_ENDPOINT: 'https://rates-parser.vercel.app/api/parse-pdf'
        };

        let uploadHistory = [];
        let currentExtractedData = null;
        let currentFilename = null;

        // Upload Zone
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        async function handleFileUpload(file) {
            if (file.type !== 'application/pdf') {
                showNotification('Please upload a PDF file', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showNotification('File size must be less than 10MB', 'error');
                return;
            }

            currentFilename = file.name;

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            progressBar.style.display = 'block';
            progressFill.style.width = '20%';
            progressFill.textContent = '20%';

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(',')[1];
                
                try {
                    progressFill.style.width = '50%';
                    progressFill.textContent = '50% - Extracting data...';

                    const response = await fetch(CONFIG.PDF_PARSER_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filename: file.name,
                            content: base64
                        })
                    });

                    const result = await response.json();

                    progressFill.style.width = '100%';
                    progressFill.textContent = '100%';

                    if (response.ok && result.success) {
                        currentExtractedData = result.data;
                        showPreview(result.data);
                        showNotification('âœ… PDF processed! Review the data below.', 'success');
                        addToUploadHistory(file.name, result.data['Bank Name'], 'success', result.data);
                        
                        setTimeout(() => {
                            progressBar.style.display = 'none';
                            progressFill.style.width = '0%';
                        }, 2000);
                    } else {
                        throw new Error(result.error || 'Upload failed');
                    }
                } catch (error) {
                    progressBar.style.display = 'none';
                    showNotification('âŒ Upload failed: ' + error.message, 'error');
                    addToUploadHistory(file.name, 'Unknown', 'error', null);
                }
            };
            reader.readAsDataURL(file);
        }

        function showPreview(data) {
            const previewSection = document.getElementById('previewSection');
            const tableBody = document.getElementById('previewTableBody');
            
            document.getElementById('extractedBankName').textContent = data['Bank Name'] || 'Unknown Bank';
            document.getElementById('extractedPeriod').textContent = data['Report Period'] || 'Period not detected';

            const fieldOrder = [
                'Bank Name', 'Report Period', 'MoPR', 'Prime Lending Rate',
                'Call Account Min', 'Call Account Max',
                'Savings Min', 'Savings Max',
                'FD 3M Nominal Min', 'FD 3M Nominal Max',
                'FD 6M Nominal Min', 'FD 6M Nominal Max',
                'FD 12M Nominal Min', 'FD 12M Nominal Max',
                'FD 24M Nominal Min', 'FD 24M Nominal Max',
                'Mortgage Rate Min', 'Mortgage Rate Max',
                'Credit Card Rate Min', 'Credit Card Rate Max',
                'Personal Loan Min', 'Personal Loan Max',
                'Contact Phone', 'Website'
            ];

            let html = '';
            let filledCount = 0;
            let totalFields = fieldOrder.length;

            fieldOrder.forEach(field => {
                const value = data[field];
                const isEmpty = value === null || value === undefined || value === '';
                if (!isEmpty) filledCount++;

                const displayValue = isEmpty ? 
                    '<span class="field-empty">Not extracted</span>' : 
                    `<span class="field-filled">${value}</span>`;

                const statusIcon = isEmpty ? 
                    '<i class="fas fa-times-circle" style="color: #dc3545;"></i>' : 
                    '<i class="fas fa-check-circle" style="color: #28a745;"></i>';

                html += `
                    <tr>
                        <th>${field}</th>
                        <td data-field="${field}">${displayValue}</td>
                        <td>${statusIcon}</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
            previewSection.classList.add('show');
            previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

            showNotification(`âœ… Extracted ${filledCount}/${totalFields} fields`, 'success');
        }

        function enableEdit() {
            const tableBody = document.getElementById('previewTableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const td = row.querySelector('td[data-field]');
                const field = td.dataset.field;
                const currentValue = currentExtractedData[field] || '';
                
                td.innerHTML = `<input type="text" value="${currentValue}" data-field="${field}" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 5px;">`;
            });

            document.querySelector('.btn-edit').textContent = 'ðŸ’¾ Save Edits';
            document.querySelector('.btn-edit').onclick = saveEdits;
        }

        function saveEdits() {
            const inputs = document.querySelectorAll('input[data-field]');
            inputs.forEach(input => {
                const field = input.dataset.field;
                let value = input.value.trim();
                
                // Convert to number if it looks like a number
                if (value && !isNaN(value) && field.includes('Rate') || field.includes('MoPR')) {
                    value = parseFloat(value);
                }
                
                currentExtractedData[field] = value || null;
            });

            showPreview(currentExtractedData);
            showNotification('âœ… Edits saved! Click "Approve & Save" to update Airtable.', 'success');
        }

        function rejectData() {
            if (confirm('Are you sure you want to reject this data? You can upload again or use manual entry.')) {
                document.getElementById('previewSection').classList.remove('show');
                currentExtractedData = null;
                showNotification('Data rejected. Upload another PDF or use manual entry.', 'error');
            }
        }

        async function approveData() {
    if (!currentExtractedData) {
        showNotification('No data to approve!', 'error');
        return;
    }

    try {
        showNotification('ðŸ’¾ Saving to Airtable...', 'info');

        // 1. Define which fields MUST be Numbers in Airtable to avoid errors
        const numericFields = [
            'MoPR', 'Prime Lending Rate', 'Current Account Rate', 
            'Call Account Min', 'Call Account Max', 'Savings Min', 'Savings Max',
            'FD 3M Nominal Min', 'FD 3M Nominal Max', 'FD 6M Nominal Min', 'FD 6M Nominal Max',
            'FD 12M Nominal Min', 'FD 12M Nominal Max', 'FD 24M Nominal Min', 'FD 24M Nominal Max',
            'FD Minimum Balance', 'USD FD 12M Min', 'USD FD 12M Max', 'ZAR FD 12M Min', 'ZAR FD 12M Max',
            'Credit Card Rate Min', 'Credit Card Rate Max', 'Data Completeness Score'
        ];

        // 2. Prepare the fields object
        const fields = {};
        for (const [key, value] of Object.entries(currentExtractedData)) {
            if (value !== null && value !== undefined && value !== '') {
                if (numericFields.includes(key)) {
                    // Clean the value: remove %, whitespace, and ensure it's a number
                    const cleanNum = typeof value === 'string' ? 
                        parseFloat(value.replace(/[^0-9.]/g, '')) : value;
                    fields[key] = isNaN(cleanNum) ? null : cleanNum;
                } else {
                    fields[key] = value;
                }
            }
        }

        // 3. Add Metadata
        fields['Last Updated'] = new Date().toISOString().split('T')[0];
        fields['Auto Updated'] = true;
        fields['Data Source'] = 'PDF Upload (Approved)';

        console.log('Sending cleaned fields to Airtable:', fields);

        // 4. Search for existing bank record
        const searchUrl = `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${encodeURIComponent(CONFIG.AIRTABLE_TABLE_NAME)}?filterByFormula={Bank Name}="${encodeURIComponent(fields['Bank Name'])}"`;
        
        const searchResponse = await fetch(searchUrl, {
            headers: { 'Authorization': `Bearer ${CONFIG.AIRTABLE_API_KEY}` }
        });
        const searchData = await searchResponse.json();

        let response;
        if (searchData.records && searchData.records.length > 0) {
            // UPDATE existing
            const recordId = searchData.records[0].id;
            response = await fetch(`https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${encodeURIComponent(CONFIG.AIRTABLE_TABLE_NAME)}/${recordId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${CONFIG.AIRTABLE_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fields })
            });
        } else {
            // CREATE new
            response = await fetch(`https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${encodeURIComponent(CONFIG.AIRTABLE_TABLE_NAME)}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${CONFIG.AIRTABLE_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fields })
            });
        }

        if (!response.ok) {
            const errorDetails = await response.json();
            throw new Error(errorDetails.error?.message || 'Airtable Save Failed');
        }

        showNotification('âœ… Successfully saved to Airtable!', 'success');
        document.getElementById('previewSection').classList.remove('show');
        updateStats();

    } catch (error) {
        console.error('Airtable Error:', error);
        showNotification('âŒ Error: ' + error.message, 'error');
    }
}

        function addToUploadHistory(filename, bankName, status, data) {
            const now = new Date();
            const fieldsExtracted = data ? Object.values(data).filter(v => v !== null && v !== undefined && v !== '').length : 0;
            
            uploadHistory.unshift({
                date: now.toLocaleString(),
                filename,
                bankName,
                status,
                fieldsExtracted
            });

            updateUploadTable();
            updateStats();
        }

        function updateUploadTable() {
            const tbody = document.getElementById('uploadsTable');
            
            if (uploadHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No uploads yet</td></tr>';
                return;
            }

            let html = '';
            uploadHistory.slice(0, 10).forEach(upload => {
                const statusClass = upload.status === 'success' ? 'status-success' : 'status-error';
                html += `
                    <tr>
                        <td>${upload.date}</td>
                        <td>${upload.filename}</td>
                        <td>${upload.bankName}</td>
                        <td><span class="status-badge ${statusClass}">${upload.status}</span></td>
                        <td>${upload.fieldsExtracted || 0} fields</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        async function updateStats() {
            try {
                const url = `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${CONFIG.AIRTABLE_TABLE_NAME}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${CONFIG.AIRTABLE_API_KEY}`
                    }
                });

                const data = await response.json();
                document.getElementById('totalBanks').textContent = data.records.length;
                
                if (data.records.length > 0) {
                    const lastUpdate = data.records[0].fields['Last Updated'];
                    if (lastUpdate) {
                        document.getElementById('lastUpload').textContent = new Date(lastUpdate).toLocaleDateString();
                    }
                }
                
                document.getElementById('totalUploads').textContent = uploadHistory.length;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const messageDiv = document.getElementById('notificationMessage');
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };
            
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                info: '#17a2b8'
            };
            
            const icon = icons[type] || icons.info;
            const color = colors[type] || colors.info;
            
            messageDiv.innerHTML = `
                <i class="fas ${icon}" style="color: ${color}; margin-right: 10px;"></i>
                ${message}
            `;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateStats();
        });
    </script>
</body>
</html>