<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin â€” BW Bank Rates</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; }

        .header {
            background: linear-gradient(135deg, #0C2340, #1a3a5c);
            color: white; padding: 20px 30px;
        }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .nav-btn {
            padding: 8px 20px; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.3);
            color: white; border-radius: 20px; text-decoration: none; margin-left: 10px;
        }

        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }

        .upload-section {
            background: white; border-radius: 16px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            margin-bottom: 30px;
        }
        .upload-zone {
            border: 2.5px dashed #C9A84C; border-radius: 14px; padding: 40px;
            text-align: center; cursor: pointer;
        }
        .upload-zone:hover { background: rgba(201,168,76,0.06); }
        .upload-icon { font-size: 3em; color: #C9A84C; margin-bottom: 10px; }
        #fileInput { display: none; }
        .progress-bar { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; margin-top: 20px; display: none; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #0C2340, #C9A84C); width: 0%; border-radius: 10px; color: white; text-align: center; line-height: 20px; font-size: 12px; }

        .preview-section {
            background: white; border-radius: 16px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            margin-bottom: 30px; display: none;
        }
        .preview-section.show { display: block; }
        
        .bank-header {
            background: linear-gradient(135deg, #0C2340, #1a3a5c);
            color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;
            display: flex; justify-content: space-between;
        }
        .bank-header h2 { font-size: 1.5em; }
        .plr-value { font-size: 2em; color: #C9A84C; }

        .action-buttons { margin: 20px 0; display: flex; gap: 10px; }
        .btn {
            padding: 10px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        .btn-approve { background: #059669; color: white; }
        .btn-reject { background: #DC2626; color: white; }
        .btn-edit { background: #F59E0B; color: white; }

        .quality-bar {
            background: #f0f0f0; border-radius: 8px; height: 8px; margin: 15px 0;
        }
        .quality-fill {
            height: 100%; border-radius: 8px; background: linear-gradient(90deg, #059669, #34D399);
            transition: width 0.5s;
        }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; text-align: left; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; }
        .section-row td { background: #0C2340; color: white; padding: 8px 12px; }

        .recent-uploads {
            background: white; border-radius: 16px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        .uploads-table { width: 100%; }
        .uploads-table th { background: #f8f9fa; padding: 12px; }
        .status-success { background: #ECFDF5; color: #059669; padding: 3px 10px; border-radius: 20px; }
        .status-error { background: #FEF2F2; color: #DC2626; padding: 3px 10px; border-radius: 20px; }

        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: white;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none;
            border-left: 4px solid #059669;
        }
        .notification.error { border-left-color: #DC2626; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-content">
        <h1><i class="fas fa-shield-alt"></i> Admin â€” BW Bank Rates</h1>
        <div>
            <a href="index.html" class="nav-btn"><i class="fas fa-home"></i> Public Site</a>
            <a href="savings.html" class="nav-btn">Savings</a>
            <a href="fixed-deposits.html" class="nav-btn">Fixed Deposits</a>
            <a href="loans.html" class="nav-btn">Loans</a>
        </div>
    </div>
</div>

<div class="container">

    <!-- Upload Section -->
    <div class="upload-section">
        <h2><i class="fas fa-file-pdf" style="color:#DC2626"></i> Upload Bank Rate PDF</h2>
        <div class="upload-zone" id="uploadZone">
            <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
            <div class="upload-text">Drop file here or click to browse</div>
            <div class="upload-subtext">PDF, JPG, PNG (max 10MB)</div>
            <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill">0%</div>
        </div>
    </div>

    <!-- Preview Section -->
    <div class="preview-section" id="previewSection">
        <div class="bank-header">
            <div>
                <h2 id="bankName">â€”</h2>
                <p id="bankPeriod">â€”</p>
            </div>
            <div class="plr-value" id="plrDisplay">â€”</div>
        </div>

        <div class="quality-label" id="qualityLabel">Extraction quality: â€”</div>
        <div class="quality-bar"><div class="quality-fill" id="qualityFill" style="width:0%"></div></div>

        <div class="action-buttons">
            <button class="btn btn-edit" onclick="enableEdit()"><i class="fas fa-edit"></i> Edit</button>
            <button class="btn btn-reject" onclick="rejectData()"><i class="fas fa-times"></i> Reject</button>
            <button class="btn btn-approve" onclick="downloadJSON()"><i class="fas fa-download"></i> Download JSON</button>
        </div>

        <table id="previewTable">
            <thead><tr><th>Field</th><th>Value</th></tr></thead>
            <tbody id="previewBody"></tbody>
        </table>
    </div>

    <!-- Upload History -->
    <div class="recent-uploads">
        <h2><i class="fas fa-history"></i> Upload History</h2>
        <table class="uploads-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Filename</th>
                    <th>Bank</th>
                    <th>Status</th>
                    <th>Fields</th>
                </tr>
            </thead>
            <tbody id="historyTable">
                <tr><td colspan="5" style="text-align:center;color:#999;padding:20px">No uploads yet</td></tr>
            </tbody>
        </table>
    </div>

</div>

<div class="notification" id="notification">
    <div id="notificationMessage"></div>
</div>

<script>
// Configuration - Uses relative URL to always call current deployment
const API_URL = '/api/parse-pdf';

let currentData = null;
let uploadHistory = [];

// Upload handlers
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');

uploadZone.addEventListener('click', () => fileInput.click());
uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length) handleFile(e.target.files[0]);
});

async function handleFile(file) {
    const ext = file.name.split('.').pop().toLowerCase();
    if (!['pdf', 'jpg', 'jpeg', 'png'].includes(ext)) {
        showNotification('Please upload PDF, JPG or PNG', 'error');
        return;
    }
    if (file.size > 10 * 1024 * 1024) {
        showNotification('File too large (max 10MB)', 'error');
        return;
    }

    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    progressBar.style.display = 'block';
    progressFill.style.width = '30%';
    progressFill.textContent = '30%';

    const reader = new FileReader();
    reader.onload = async (e) => {
        const base64 = e.target.result.split(',')[1];
        
        try {
            progressFill.style.width = '60%';
            progressFill.textContent = '60% - Processing...';

            console.log('Sending to:', API_URL);
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filename: file.name,
                    content: base64
                })
            });

            const result = await response.json();
            console.log('Response:', result);
            
            progressFill.style.width = '100%';
            progressFill.textContent = '100%';

            if (response.ok && result.success) {
                currentData = result.data;
                showPreview(result.data);
                showNotification('âœ… Success: ' + result.message);
                addToHistory(file.name, result.data['Bank Name'] || 'Unknown', 'success', result.quality);
            } else {
                throw new Error(result.error || result.details || 'Upload failed');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('âŒ Error: ' + error.message, 'error');
            addToHistory(file.name, 'Unknown', 'error', 0);
        } finally {
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }, 2000);
        }
    };
    reader.readAsDataURL(file);
}

function showPreview(data) {
    const tbody = document.getElementById('previewBody');
    document.getElementById('bankName').textContent = data['Bank Name'] || 'Unknown';
    document.getElementById('bankPeriod').textContent = data['Data Month'] || 'Period not detected';
    document.getElementById('plrDisplay').textContent = data['Prime Lending Rate'] ? data['Prime Lending Rate'] + '%' : 'â€”';

    // Calculate quality
    const fields = Object.values(data).filter(v => v !== null && v !== '').length;
    const total = 44;
    const pct = Math.round((fields / total) * 100);
    document.getElementById('qualityLabel').textContent = `Extraction: ${fields}/${total} fields (${pct}%)`;
    document.getElementById('qualityFill').style.width = pct + '%';

    // Build table
    let html = '';
    const sections = [
        { label: 'ðŸ“‹ Bank Info', fields: ['Bank Name', 'Data Month', 'MoPR', 'Prime Lending Rate', 'Website', 'Contact Phone'] },
        { label: 'ðŸ’° Savings', fields: ['Current Account Min', 'Current Account Max', 'Call Account Min', 'Call Account Max', 'Call Account Effective Min', 'Call Account Effective Max', 'Savings Min', 'Savings Max', 'Savings Effective Min', 'Savings Effective Max'] },
        { label: 'ðŸ”’ Fixed Deposits', fields: ['FD 3M Nominal Min', 'FD 3M Nominal Max', 'FD 6M Nominal Min', 'FD 6M Nominal Max', 'FD 12M Nominal Min', 'FD 12M Nominal Max', 'FD 24M Nominal Min', 'FD 24M Nominal Max', 'FD Over24M Nominal Min', 'FD Over24M Nominal Max'] },
        { label: 'ðŸ¦ Loans', fields: ['Mortgage Rate Min', 'Mortgage Rate Max', 'Personal Loan Min', 'Personal Loan Max', 'Car Loan Min', 'Car Loan Max', 'Credit Card Rate Min', 'Credit Card Rate Max'] }
    ];

    sections.forEach(section => {
        html += `<tr class="section-row"><td colspan="2">${section.label}</td></tr>`;
        section.fields.forEach(field => {
            const value = data[field];
            html += `<tr>
                <th>${field}</th>
                <td>${value !== null && value !== '' ? value : '<span style="color:#DC2626">â€”</span>'}</td>
            </tr>`;
        });
    });

    tbody.innerHTML = html;
    document.getElementById('previewSection').classList.add('show');
}

function enableEdit() {
    const rows = document.querySelectorAll('#previewBody tr:not(.section-row)');
    rows.forEach(row => {
        const field = row.querySelector('th').textContent;
        const td = row.querySelector('td');
        const value = currentData[field] || '';
        td.innerHTML = `<input type="text" value="${value}" data-field="${field}" style="width:100%; padding:5px; border:1px solid #C9A84C; border-radius:4px;">`;
    });
}

function rejectData() {
    if (confirm('Reject this data?')) {
        document.getElementById('previewSection').classList.remove('show');
        currentData = null;
        showNotification('Data rejected');
    }
}

function downloadJSON() {
    if (!currentData) return;
    
    const dataStr = JSON.stringify(currentData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = (currentData['Bank Name'] || 'bank') + '_rates.json';
    a.click();
    
    URL.revokeObjectURL(url);
    showNotification('âœ… JSON downloaded');
}

function addToHistory(filename, bank, status, fields) {
    uploadHistory.unshift({
        time: new Date().toLocaleTimeString(),
        filename,
        bank,
        status,
        fields: fields || '0/44'
    });
    
    const tbody = document.getElementById('historyTable');
    tbody.innerHTML = uploadHistory.map(h => `
        <tr>
            <td>${h.time}</td>
            <td>${h.filename}</td>
            <td><strong>${h.bank}</strong></td>
            <td><span class="status-${h.status}">${h.status}</span></td>
            <td>${h.fields}</td>
        </tr>
    `).join('');
}

function showNotification(message, type = 'success') {
    const el = document.getElementById('notification');
    document.getElementById('notificationMessage').textContent = message;
    el.className = `notification ${type}`;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 3000);
}
</script>
</body>
</html>

